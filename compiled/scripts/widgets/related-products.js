define(["modules/jquery-mozu","shim!vendor/underscore>_","modules/api","modules/backbone-mozu","modules/models-product"],function(e,t,r,o,a){var u=function(e,o,a){var u=t.map(o,function(e){return"ProductCode eq "+e}).join(" or "),c="";switch(e){case"product":c=r.get("search",{filter:u});break;case"cart":c=r.get("search",{filter:u,pageSize:a})}return c},c=require.mozuData("pagecontext");e(document).ready(function(){var r=[];switch(c.pageType){case"product":r.push(require.mozuData("product"));break;case"cart":var n=require.mozuData("cart").items;e.each(n,function(e,t){r.push(t.product)})}e("[data-mz-related-products]").each(function(n,d){d=e(d);for(var i=d.data("mzRelatedProducts"),p=i.attributeId||"tenant~product-crosssell",s=i.template||"modules/product/product-list-carousel",l=i.title,m=i.count||5,h=[],f=o.MozuView.extend({templateName:s}),v=0;v<r.length;v++){var g=r[v];if(g&&g.properties)for(var b=0;b<g.properties.length;b++)if(g.properties[b].attributeFQN==p){var z=t.pluck(g.properties[b].values,"value");h=h.concat(e.grep(z||[],function(e){return!!e}))}}return h&&h.length?(u(c.pageType,h,m).then(function(e){var t=new a.ProductCollection(e.data),r=new f({model:t,el:d});r.render(),d.prepend("<h3>"+l+"</h3>")}),void 0):(c.isEditMode&&d.html("<b>tbd preview content</b>"),void 0)})})});